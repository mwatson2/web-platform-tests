<!doctype html>
<html>
  <head>
    <meta charset=utf-8>
    <meta name="timeout" content="long">
    <title>Encrypted Media Extensions: Retrieve stored persistent-usage-record</title>
    <link rel="help" href="https://w3c.github.io/encrypted-media/">

    <!-- Helper scripts for Encrypted Media Extensions tests  -->
    <script src=/encrypted-media/util/utils.js></script>
    <script src=/encrypted-media/util/fetch.js></script>
    <script src=/encrypted-media/util/utf8.js></script>

    <!-- Message handler for Clear Key keysystem -->
    <script src=/encrypted-media/util/clearkey-messagehandler.js></script>

  </head>
  <body>
    <div id='log'></div>

    <script>

    window.addEventListener( 'message', function( event ) {
    
        consoleWrite( JSON.stringify( event ) );

        var config = event.data.config,
            configuration = {   initDataTypes: [ config.initDataType ],
                                audioCapabilities: [ { contentType: config.audioType } ],
                                videoCapabilities: [ { contentType: config.videoType } ],
                                sessionTypes: [ 'persistent-usage-record' ] },
            assertions = [ ];

            config.messagehandler = messagehandler;
            
        function onFailure(error) {
            
            assertions.push( { actual: false, expected: true, message: error } );

            window.opener.postMessage(assertions, '*');
        }


        function onMessage( event )
        {
            assertions.push( { expected: true, actual: event instanceof window.MediaKeyMessageEvent, message: "event is of correct class" } );
            assertions.push( { expected: 'message', actual: event.type, message: "event type is message" } );
            assertions.push( { expected: 'license-release', actual: event.messageType, message: "message type is license-release" } );

            var release = fromUtf8( event.message );

            consoleWrite( JSON.stringify( release ) );

            assertions.push( { expected: 1, actual: release.kids.length, message: "release message contains a single key" } );
            assertions.push( { expected: true, actual: ( typeof release.firstTime === 'number' ), message: "firstTime is a number" } );
            assertions.push( { expected: true, actual: ( typeof release.latestTime === 'number' ), message: "latestTime is a number" } );

            var duration = release.latestTime - release.firstTime;
            assertions.push( { expected: true, actual: ( duration >= 2000 ), message: "duration >= 2s" } );
            assertions.push( { expected: true, actual: ( duration < 4000 ), message: "duration < 4s" } );

            config.messagehandler( config.keysystem, event.messageType, event.message )
            .then( function( response ) {
                event.target.update( response ).catch( onFailure );
            });
        }

        navigator.requestMediaKeySystemAccess(config.keysystem, [ configuration ] ).then(function(access) {

            return access.createMediaKeys();

        }).then(function(mediaKeys) {

            var mediaKeySession = mediaKeys.createSession( 'persistent-release-message' );

            mediaKeySession.addEventListener( 'message', onMessage );
            mediaKeySession.closed.then( function() {

                window.opener.postMessage(assertions, '*');

            });
                
            var certBytes = base64DecodeToUnit8Array(
             'Q0hBSQAAAAEAAAUMAAAAAAAAAAJDRVJUAAAAAQAAAfwAAAFsAAEAAQAAAFhr+y4Ydms5rTmj6bCCteW2' +
             'AAAAAAAAAAAAAAAJzZtwNxHterM9CAoJYOM3CF9Tj0d9KND413a+UtNzRTb/////AAAAAAAAAAAAAAAA' +
             'AAAAAAABAAoAAABU8vU0ozkqocBJMVIX2K4dugAAADZodHRwOi8vbnJkcC5uY2NwLm5ldGZsaXguY29t' +
             'L3Jtc2RrL3JpZ2h0c21hbmFnZXIuYXNteAAAAAABAAUAAAAMAAAAAAABAAYAAABcAAAAAQABAgAAAAAA' +
             'glDQ2GehCoNSsOaaB8zstNK0cCnf1+9gX8wM+2xwLlqJ1kyokCjt3F8P2NqXHM4mEU/G1T0HBBSI3j6X' +
             'pKqzgAAAAAEAAAACAAAABwAAAEgAAAAAAAAACE5ldGZsaXgAAAAAH1BsYXlSZWFkeSBNZXRlcmluZyBD' +
             'ZXJ0aWZpY2F0ZQAAAAAABjIwMjQ4AAAAAAEACAAAAJAAAQBAU73up7T8eJYVK4UHuKYgMQIRbo0yf27Y' +
             '5EPZRPmzkx1ZDMor7Prs77CAOU9S9k0RxpxPnqUwAKRPIVCe0aX2+AAAAgBb65FSx1oKG2r8AxQjio+U' +
             'rYGLhvA7KMlxJBbPXosAV/CJufnIdUMSA0DhxD2W3eRLh2vHukIL4VH9guUcEBXsQ0VSVAAAAAEAAAL8' +
             'AAACbAABAAEAAABYyTlnSi+jZfRvYL0rk9sVfwAAAAAAAAAAAAAABFNh3USSkWi88BlSM6PZ2gMuceJF' +
             'J9hzz0WzuCiwF9qv/////wAAAAAAAAAAAAAAAAAAAAAAAQAFAAAADAAAAAAAAQAGAAAAYAAAAAEAAQIA' +
             'AAAAAFvrkVLHWgobavwDFCOKj5StgYuG8DsoyXEkFs9eiwBX8Im5+ch1QxIDQOHEPZbd5EuHa8e6Qgvh' +
             'Uf2C5RwQFewAAAACAAAAAQAAAAwAAAAHAAABmAAAAAAAAACATWljcm9zb2Z0AAAAAAAAAAAAAAAAAAAA' +
             'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
             'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAUGxheVJlYWR5IFNM' +
             'MCBNZXRlcmluZyBSb290IENBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
             'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACA' +
             'MS4wLjAuMQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
             'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
             'AAAAAAAAAAAAAQAIAAAAkAABAECsAomwQgNY0bm6U6Au9JRvwjbNnRzmVkZi+kg7npnRQ2T+4LgyrePB' +
             'dBRQ3qb/jxXkn++4sOFa7vjRpFBzV0MMAAACAIZNYc/yJW5CLFaLPCgAHPs+FSdlhYS6BSG3mxgo2Tbe' +
             'HYJqj8Pm5/p6kNXKKUbx9kou+59dz/5+Q060QpP6xas=' );
                
            mediaKeys.setServerCertificate(certBytes).then(function () {
                consoleWrite( 'setServerCertificate succeeded' );
            } );
            
            consoleWrite( "Loading... " + event.data.sessionId );

            return mediaKeySession.load( event.data.sessionId /*'KgA='*/ ).then(function( success ) {
                consoleWrite( "Loading " + success );
                
                if ( success ) {
                    mediaKeySession.remove().then( function() {
                        consoleWrite( "Remove succeeded...")
                    }).catch(onFailure);
                } else {
                    onFailure( "Load failed" );
                }
            })
            .catch( function( error ) { consoleWrite( "Loading failed: " + error ); onFailure( error ); } );

        }).catch( onFailure );

    } );

    </script>
  </body>
</html>